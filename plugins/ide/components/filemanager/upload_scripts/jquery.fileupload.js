!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","jquery.ui.widget"],e):e(window.jQuery)}(function(h){"use strict";h.support.xhrFileUpload=!(!window.XMLHttpRequestUpload||!window.FileReader),h.support.xhrFormDataFileUpload=!!window.FormData,h.widget("blueimp.fileupload",{options:{namespace:void 0,dropZone:h(document),fileInput:void 0,replaceFileInput:!0,paramName:void 0,singleFileUploads:!0,limitMultiFileUploads:void 0,sequentialUploads:!1,limitConcurrentUploads:void 0,forceIframeTransport:!1,redirect:void 0,redirectParamName:void 0,postMessage:void 0,multipart:!0,maxChunkSize:void 0,uploadedBytes:void 0,recalculateProgress:!0,progressInterval:100,bitrateInterval:500,formData:function(e){return e.serializeArray()},add:function(e,t){t.submit()},processData:!1,contentType:!1,cache:!1},_refreshOptionsList:["namespace","dropZone","fileInput","multipart","forceIframeTransport"],_BitrateTimer:function(){this.timestamp=+new Date,this.loaded=0,this.bitrate=0,this.getBitrate=function(e,t,i){var n=e-this.timestamp;return(!this.bitrate||!i||i<n)&&(this.bitrate=(t-this.loaded)*(1e3/n)*8,this.loaded=t,this.timestamp=e),this.bitrate}},_isXHRUpload:function(e){return!e.forceIframeTransport&&(!e.multipart&&h.support.xhrFileUpload||h.support.xhrFormDataFileUpload)},_getFormData:function(e){var i;return"function"==typeof e.formData?e.formData(e.form):h.isArray(e.formData)?e.formData:e.formData?(i=[],h.each(e.formData,function(e,t){i.push({name:e,value:t})}),i):[]},_getTotal:function(e){var i=0;return h.each(e,function(e,t){i+=t.size||1}),i},_onProgress:function(e,t){if(e.lengthComputable){var i,n,r=+new Date;if(t._time&&t.progressInterval&&r-t._time<t.progressInterval&&e.loaded!==e.total)return;t._time=r,i=t.total||this._getTotal(t.files),n=parseInt(e.loaded/e.total*(t.chunkSize||i),10)+(t.uploadedBytes||0),this._loaded+=n-(t.loaded||t.uploadedBytes||0),t.lengthComputable=!0,t.loaded=n,t.total=i,t.bitrate=t._bitrateTimer.getBitrate(r,n,t.bitrateInterval),this._trigger("progress",e,t),this._trigger("progressall",e,{lengthComputable:!0,loaded:this._loaded,total:this._total,bitrate:this._bitrateTimer.getBitrate(r,this._loaded,t.bitrateInterval)})}},_initProgressListener:function(i){var n=this,e=i.xhr?i.xhr():h.ajaxSettings.xhr();e.upload&&(h(e.upload).bind("progress",function(e){var t=e.originalEvent;e.lengthComputable=t.lengthComputable,e.loaded=t.loaded,e.total=t.total,n._onProgress(e,i)}),i.xhr=function(){return e})},_initXHRData:function(i){var n,e=i.files[0],t=i.multipart||!h.support.xhrFileUpload,r=i.paramName[0];t&&!i.blob||(i.headers=h.extend(i.headers,{"X-File-Name":e.name,"X-File-Type":e.type,"X-File-Size":e.size}),i.blob?t||(i.contentType="application/octet-stream",i.data=i.blob):(i.contentType=e.type,i.data=e)),t&&h.support.xhrFormDataFileUpload&&(i.postMessage?(n=this._getFormData(i),i.blob?n.push({name:r,value:i.blob}):h.each(i.files,function(e,t){n.push({name:i.paramName[e]||r,value:t})})):(i.formData instanceof FormData?n=i.formData:(n=new FormData,h.each(this._getFormData(i),function(e,t){n.append(t.name,t.value)})),i.blob?n.append(r,i.blob,e.name):h.each(i.files,function(e,t){t instanceof Blob&&n.append(i.paramName[e]||r,t,t.name)})),i.data=n),i.blob=null},_initIframeSettings:function(e){e.dataType="iframe "+(e.dataType||""),e.formData=this._getFormData(e),e.redirect&&h("<a></a>").prop("href",e.url).prop("host")!==location.host&&e.formData.push({name:e.redirectParamName||"redirect",value:e.redirect})},_initDataSettings:function(e){this._isXHRUpload(e)?(this._chunkedUpload(e,!0)||(e.data||this._initXHRData(e),this._initProgressListener(e)),e.postMessage&&(e.dataType="postmessage "+(e.dataType||""))):this._initIframeSettings(e,"iframe")},_getParamName:function(e){var t=h(e.fileInput),n=e.paramName;return n?h.isArray(n)||(n=[n]):(n=[],t.each(function(){for(var e=h(this),t=e.prop("name")||"files[]",i=(e.prop("files")||[1]).length;i;)n.push(t),i-=1}),n.length||(n=[t.prop("name")||"files[]"])),n},_initFormSettings:function(e){e.form&&e.form.length||(e.form=h(e.fileInput.prop("form"))),e.paramName=this._getParamName(e),e.url||(e.url=e.form.prop("action")||location.href),e.type=(e.type||e.form.prop("method")||"").toUpperCase(),"POST"!==e.type&&"PUT"!==e.type&&(e.type="POST"),e.formAcceptCharset||(e.formAcceptCharset=e.form.attr("accept-charset"))},_getAJAXSettings:function(e){var t=h.extend({},this.options,e);return this._initFormSettings(t),this._initDataSettings(t),t},_enhancePromise:function(e){return e.success=e.done,e.error=e.fail,e.complete=e.always,e},_getXHRPromise:function(e,t,i){var n=h.Deferred(),r=n.promise();return t=t||this.options.context||r,!0===e?n.resolveWith(t,i):!1===e&&n.rejectWith(t,i),r.abort=n.promise,this._enhancePromise(r)},_chunkedUpload:function(i,e){var n,r,a,t,o=this,s=i.files[0],l=s.size,p=i.uploadedBytes=i.uploadedBytes||0,d=i.maxChunkSize||l,u=s.webkitSlice||s.mozSlice||s.slice;return!(!(this._isXHRUpload(i)&&u&&(p||d<l))||i.data)&&(!!e||(l<=p?(s.error="uploadedBytes",this._getXHRPromise(!1,i.context,[null,"error",s.error])):(r=Math.ceil((l-p)/d),(t=(n=function(t){return t?n(t-=1).pipe(function(){var e=h.extend({},i);return e.blob=u.call(s,p+t*d,p+(t+1)*d),e.chunkIndex=t,e.chunksNumber=r,e.chunkSize=e.blob.size,o._initXHRData(e),o._initProgressListener(e),a=(h.ajax(e)||o._getXHRPromise(!1,e.context)).done(function(){e.loaded||o._onProgress(h.Event("progress",{lengthComputable:!0,loaded:e.chunkSize,total:e.chunkSize}),e),i.uploadedBytes=e.uploadedBytes+=e.chunkSize})}):o._getXHRPromise(!0,i.context)})(r)).abort=function(){return a.abort()},this._enhancePromise(t))))},_beforeSend:function(e,t){0===this._active&&(this._trigger("start"),this._bitrateTimer=new this._BitrateTimer),this._active+=1,this._loaded+=t.uploadedBytes||0,this._total+=this._getTotal(t.files)},_onDone:function(e,t,i,n){this._isXHRUpload(n)||this._onProgress(h.Event("progress",{lengthComputable:!0,loaded:1,total:1}),n),n.result=e,n.textStatus=t,n.jqXHR=i,this._trigger("done",null,n)},_onFail:function(e,t,i,n){n.jqXHR=e,n.textStatus=t,n.errorThrown=i,this._trigger("fail",null,n),n.recalculateProgress&&(this._loaded-=n.loaded||n.uploadedBytes||0,this._total-=n.total||this._getTotal(n.files))},_onAlways:function(e,t,i,n){this._active-=1,n.textStatus=t,i&&i.always?(n.jqXHR=i,n.result=e):(n.jqXHR=e,n.errorThrown=i),this._trigger("always",null,n),0===this._active&&(this._trigger("stop"),this._loaded=this._total=0,this._bitrateTimer=null)},_onSend:function(i,e){var n,t,r,a=this,o=a._getAJAXSettings(e),s=function(e,t){return a._sending+=1,o._bitrateTimer=new a._BitrateTimer,n=n||(!1!==e&&!1!==a._trigger("send",i,o)&&(a._chunkedUpload(o)||h.ajax(o))||a._getXHRPromise(!1,o.context,t)).done(function(e,t,i){a._onDone(e,t,i,o)}).fail(function(e,t,i){a._onFail(e,t,i,o)}).always(function(e,t,i){if(a._sending-=1,a._onAlways(e,t,i,o),o.limitConcurrentUploads&&o.limitConcurrentUploads>a._sending)for(var n=a._slots.shift();n;){if(n.state?"pending"===n.state():!n.isRejected()){n.resolve();break}n=a._slots.shift()}})};return this._beforeSend(i,o),this.options.sequentialUploads||this.options.limitConcurrentUploads&&this.options.limitConcurrentUploads<=this._sending?(1<this.options.limitConcurrentUploads?(t=h.Deferred(),this._slots.push(t),r=t.pipe(s)):r=this._sequence=this._sequence.pipe(s,s),r.abort=function(){var e=[void 0,"abort","abort"];return n?n.abort():(t&&t.rejectWith(r,e),s(!1,e))},this._enhancePromise(r)):s()},_onAdd:function(n,r){var a,e,o,t,s=this,l=!0,i=h.extend({},this.options,r),p=i.limitMultiFileUploads,d=this._getParamName(i);if((i.singleFileUploads||p)&&this._isXHRUpload(i))if(!i.singleFileUploads&&p)for(o=[],a=[],t=0;t<r.files.length;t+=p)o.push(r.files.slice(t,t+p)),(e=d.slice(t,t+p)).length||(e=d),a.push(e);else a=d;else o=[r.files],a=[d];return r.originalFiles=r.files,h.each(o||r.files,function(e,t){var i=h.extend({},r);return i.files=o?t:[t],i.paramName=a[e],i.submit=function(){return i.jqXHR=this.jqXHR=!1!==s._trigger("submit",n,this)&&s._onSend(n,this),this.jqXHR},l=s._trigger("add",n,i)}),l},_replaceFileInput:function(i){var n=i.clone(!0);h("<form></form>").append(n)[0].reset(),i.after(n).detach(),h.cleanData(i.unbind("remove")),this.options.fileInput=this.options.fileInput.map(function(e,t){return t===i[0]?n[0]:t}),i[0]===this.element[0]&&(this.element=n)},_handleFileTreeEntry:function(t,i){var n=this,r=h.Deferred(),a=function(){r.reject()};return i=i||"",t.isFile?t.file(function(e){e.relativePath=i,r.resolve(e)},a):t.isDirectory?t.createReader().readEntries(function(e){n._handleFileTreeEntries(e,i+t.name+"/").done(function(e){r.resolve(e)}).fail(a)},a):a(),r.promise()},_handleFileTreeEntries:function(e,t){var i=this;return h.when.apply(h,h.map(e,function(e){return i._handleFileTreeEntry(e,t)})).pipe(function(){return Array.prototype.concat.apply([],arguments)})},_getDroppedFiles:function(e){var t=(e=e||{}).items;return t&&t.length&&(t[0].webkitGetAsEntry||t[0].getAsEntry)?this._handleFileTreeEntries(h.map(t,function(e){return e.webkitGetAsEntry?e.webkitGetAsEntry():e.getAsEntry()})):h.Deferred().resolve(h.makeArray(e.files)).promise()},_getFileInputFiles:function(e){var t,i,n=(e=h(e)).prop("webkitEntries")||e.prop("entries");if(n&&n.length)return this._handleFileTreeEntries(n);if(!(t=h.makeArray(e.prop("files"))).length){if(!(i=e.prop("value")))return h.Deferred().reject([]).promise();t=[{name:i.replace(/^.*\\/,"")}]}return h.Deferred().resolve(t).promise()},_onChange:function(t){var i=t.data.fileupload,n={fileInput:h(t.target),form:h(t.target.form)};i._getFileInputFiles(n.fileInput).always(function(e){n.files=e,i.options.replaceFileInput&&i._replaceFileInput(n.fileInput),!1!==i._trigger("change",t,n)&&i._onAdd(t,n)})},_onPaste:function(e){var t=e.data.fileupload,i=e.originalEvent.clipboardData,n=i&&i.items||[],r={files:[]};if(h.each(n,function(e,t){var i=t.getAsFile&&t.getAsFile();i&&r.files.push(i)}),!1===t._trigger("paste",e,r)||!1===t._onAdd(e,r))return!1},_onDrop:function(t){t.preventDefault();var i=t.data.fileupload,e=t.dataTransfer=t.originalEvent.dataTransfer,n={};i._getDroppedFiles(e).always(function(e){n.files=e,!1!==i._trigger("drop",t,n)&&i._onAdd(t,n)})},_onDragOver:function(e){var t=e.data.fileupload,i=e.dataTransfer=e.originalEvent.dataTransfer;if(!1===t._trigger("dragover",e))return!1;i&&(i.dropEffect="copy"),e.preventDefault()},_initEventHandlers:function(){var e=this.options.namespace;this._isXHRUpload(this.options)&&this.options.dropZone.bind("dragover."+e,{fileupload:this},this._onDragOver).bind("drop."+e,{fileupload:this},this._onDrop).bind("paste."+e,{fileupload:this},this._onPaste),this.options.fileInput.bind("change."+e,{fileupload:this},this._onChange)},_destroyEventHandlers:function(){var e=this.options.namespace;this.options.dropZone.unbind("dragover."+e,this._onDragOver).unbind("drop."+e,this._onDrop).unbind("paste."+e,this._onPaste),this.options.fileInput.unbind("change."+e,this._onChange)},_setOption:function(e,t){var i=-1!==h.inArray(e,this._refreshOptionsList);i&&this._destroyEventHandlers(),h.Widget.prototype._setOption.call(this,e,t),i&&(this._initSpecialOptions(),this._initEventHandlers())},_initSpecialOptions:function(){var e=this.options;void 0===e.fileInput?e.fileInput=this.element.is('input[type="file"]')?this.element:this.element.find('input[type="file"]'):e.fileInput instanceof h||(e.fileInput=h(e.fileInput)),e.dropZone instanceof h||(e.dropZone=h(e.dropZone))},_create:function(){var e=this.options;h.extend(e,h(this.element[0].cloneNode(!1)).data()),e.namespace=e.namespace||this.widgetName,this._initSpecialOptions(),this._slots=[],this._sequence=this._getXHRPromise(!0),this._sending=this._active=this._loaded=this._total=0,this._initEventHandlers()},destroy:function(){this._destroyEventHandlers(),h.Widget.prototype.destroy.call(this)},enable:function(){var e=!1;this.options.disabled&&(e=!0),h.Widget.prototype.enable.call(this),e&&this._initEventHandlers()},disable:function(){this.options.disabled||this._destroyEventHandlers(),h.Widget.prototype.disable.call(this)},add:function(t){var i=this;t&&!this.options.disabled&&(t.fileInput&&!t.files?this._getFileInputFiles(t.fileInput).always(function(e){t.files=e,i._onAdd(null,t)}):(t.files=h.makeArray(t.files),this._onAdd(null,t)))},send:function(t){if(t&&!this.options.disabled){if(t.fileInput&&!t.files){var i,n,r=this,a=h.Deferred(),e=a.promise();return e.abort=function(){return n=!0,i?i.abort():(a.reject(null,"abort","abort"),e)},this._getFileInputFiles(t.fileInput).always(function(e){n||(t.files=e,i=r._onSend(null,t).then(function(e,t,i){a.resolve(e,t,i)},function(e,t,i){a.reject(e,t,i)}))}),this._enhancePromise(e)}if(t.files=h.makeArray(t.files),t.files.length)return this._onSend(null,t)}return this._getXHRPromise(!1,t&&t.context)}})});